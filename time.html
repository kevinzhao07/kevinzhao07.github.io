<!DOCTYPE html>
<html>
  
  <head>
    <title>age counter</title>
    <link rel="stylesheet" href="time.css">
    <script src="https://kit.fontawesome.com/59df0f1cf2.js" crossorigin="anonymous"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
  </head>

  <body class="bg">

    <div id="birthdate">

      <div class="header">
        <img class="cake" src="images/cake.png">
        <h1 class="title">when's your birthday?</h1>
      </div>

      <div class="content">
        <form onsubmit="return calculate_age()">
          <label> month </label>
          <input id="month" class="input-date" type="text" maxlength="2" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required/>        
          <label> day </label>
          <input id="day" class="input-date" type="text" maxlength="2" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required/>        
          <label> year </label>
          <input id="year" class="input-date" type="text" maxlength="4" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required/>        
          <button class="submit" type="submit" name="Submit" val><i class="reg fas fa-arrow-right"></i></button>
          <p id="error"></p>
        </form>
      </div>

    </div>

    <div id="container">
      <div id="age_counter" class="age_counter">
        <h1 class="title-age-one">your current age:</h1>
        <p id="age"></p>
      </div>
  
      <div id="time" class="time">
        <h1 class="title-age">it is:</h1>
        <p id="time-now"></p>
        <p id="date-now"></p>
      </div>
    </div>

    <div id="footer" class="footer">
      <div id="weather">
        <div id="one"></div>
        <div id="two"></div>
        <div id="three"></div>
      </div>

      <div id="stocks">
        <div id="VOO"></div>
        <div id="DIA"></div>
        <div id="QQQ"></div>
      </div>
    </div>

    <!-- <div id="day_percent" class="day_percent">
      <h1 class="title-age">today is already: </h1>
      <p id="percent_of_day"></p>
      <p class="misc"> over. do something. </p>
    </div> -->

  </body>

  <script>
    function calculate_age() {
      // get constants from user input
      var month = document.getElementById("month").value;
      var day = document.getElementById("day").value;
      var year = document.getElementById("year").value;
      var now = new Date();

      // error handling (if year is incorrect)
      if (year < 1000) {
        document.getElementById("error").innerHTML = "Please enter a valid date.";
        return false;
      }
      
      // if date is invalid, re-ask user for input
      var birthday = new Date(year + "/" + month + "/" + day);
      if (birthday == "Invalid Date") {
        document.getElementById("error").innerHTML = "Please enter a valid date.";
        return false;
      }

      if (birthday >= now) {
        document.getElementById("error").innerHTML = "Entered date must be before today.";
        return false;
      }

      // calculate current age, and time til 82
      var ms_year = 31557807360
      var curr_age = (now.getTime() - birthday.getTime()) * 1.0 / ms_year
      var years_left = 78.54 - curr_age
      var curr_age_time = curr_age * 1000000000
      var years_left_time = years_left * ms_year

      // calculate percentage
      var percentage = curr_age / 78.54 * 100.0

      // calculate current time
      var then = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate(),
          0,0,0),
      diff = now.getTime() - then.getTime();

      // change HTML design after submitting age
      document.getElementById("age").innerHTML = age;
      var element = document.getElementById("age_counter");
      element.classList.remove("age_counter");
      var element = document.getElementById("time");
      element.classList.remove("time");
      var element = document.getElementById("footer");
      element.classList.remove("footer");
      var element = document.getElementById("birthdate");
      element.classList.add("birthdate");
      
      animateValue("age", curr_age_time, 78540000000, years_left_time);

      return false;
    }

    function animateValue(id, start, end, duration) {
      // assumes integer values for start and end
      
      var obj = document.getElementById(id);
      var obj_time = document.getElementById("time-now");
      var obj_date = document.getElementById("date-now");
      var range = end - start;
      // no timer shorter than 50ms (not really visible any way)
      var minTimer = 50;
      // calc step time to show all interediate values
      var stepTime = Math.abs(Math.floor(duration / range));
      
      // never go below minTimer
      stepTime = Math.max(stepTime, minTimer);
      
      // get current time and calculate desired end time
      var startTime = new Date().getTime();
      var endTime = startTime + duration;
      var timer;
    
      function run() {
          var now = new Date().getTime();
          var remaining = Math.max((endTime - now) / duration, 0);

          // edit value
          var value = Math.round(end - (remaining * range)) * 1.0 / 1000000000;
          obj.innerHTML = value.toFixed(9)

          var today = new Date();
          var today_hours = today.getHours().toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false})
          var today_minutes = today.getMinutes().toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false})
          var today_seconds = today.getSeconds().toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false})
          var time = today_hours + ":" + today_minutes + "<span class='seconds'>: " + today_seconds + " </span>";
          obj_time.innerHTML = time;

          const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
          const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
          var today_month = months[today.getMonth()];
          var today_date = today.getDate().toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false})
          var today_year = today.getFullYear();
          var today_day = days[today.getDay()];
          var date = today_day + ", " + today_month + " " + today_date + ", " + today_year
          obj_date.innerHTML = date;

          if (value == end) {
            clearInterval(timer);
          }
      }
      
      timer = setInterval(run, stepTime);
      run();
    }

    function weatherStocks() {

      var weather_one = document.getElementById("one");
      var weather_two = document.getElementById("two");
      var weather_three = document.getElementById("three");
      let data = {}
      let request = new XMLHttpRequest();
        request.open("GET", "https://api.weatherapi.com/v1/forecast.json?key=6dfedeba1486452f89152852211206&q=48105&days=2&aqi=no&alerts=no");
        request.send();
        request.onload = () => {

          // do all the weather updating here
          if (request.status === 200) {
            data = JSON.parse(request.response);
            data = data["forecast"]["forecastday"]
            weather_today = data[0]["hour"]
            weather_tom = data[1]["hour"]

            // calculating what hour to start at (next hour)
            var now = Date.now() / 1000;
            var start_weather = 24;
            for (var x = 0; x < weather_today.length; ++x) {
              if (now < weather_today[x]["time_epoch"]) {
                start_weather = x;
                break;
              }
            }

            for (var x = 0; x < weather_tom.length; ++x) {
              weather_today.push(weather_tom[x]);
            }

            // finding weather for next 3 hours
            weather_data = []
            weather_data.push(weather_today[start_weather++])
            weather_data.push(weather_today[start_weather++])
            weather_data.push(weather_today[start_weather++])

            var icons = []
            console.log(weather_data);
            for (var x = 0; x < weather_data.length; ++x) {
              var condition = weather_data[x]["condition"]["text"].toLowerCase();
              var code = weather_data[x]["condition"]["code"];
              var day = weather_data[x]["is_day"];
              var hour = weather_data[x]["time"].substring(11, 13)
              var will_rain = weather_data[x]["will_it_rain"];
              var cloud = weather_data[x]["cloud"]
              var icon = "";

              if (condition == "sunny") {
                icon = '<i class="fas fa-sun"></i>'
              }

              else if (condition == "clear") {
                icon = '<i class="fas fa-moon"></i>'
              }

              else if (will_rain == 0) {
                // clear (no clouds)
                if (cloud < 30) {
                  if (day == 1) {
                    icon = '<i class="fas fa-sun"></i>'
                  }
                  else {
                    icon = '<i class="fas fa-moon"></i>'
                  }
                }

                // partly cloudy
                if (cloud >= 30 && cloud < 70) {
                  if (day == 1) {
                    icon = '<i class="fas fa-cloud-sun"></i>'
                  }
                  else {
                    icon = '<i class="fas fa-cloud-moon"></i>'
                  }
                }

                else {
                  icon = '<i class="fas fa-cloud"></i>'
                }
              }

              else if (condition == "partly cloudy") {
                if (day == 0) {
                  icon = '<i class="fas fa-cloud-moon"></i>'
                }
                else {
                  icon = '<i class="fas fa-cloud-sun"></i>'
                }
              }

              else if (condition == "cloudy" || condition == "overcast") {
                icon = '<i class="fas fa-cloud"></i>'
              }

              else if (code == 1030 || code == 1135 || code == 1147) {
                icon = '<i class="fas fa-smog"></i>'
              }

              else if (condition.includes("rain") || condition.includes("drizzle") || condition.includes("shower")) {
                
                icon = '<i class="fas fa-cloud-rain"></i>';
                
                if (condition.includes("moderate") || condition.includes("heavy") || condition.includes("torrential")) {
                  icon = '<i class="fas fa-cloud-showers-heavy"></i>'
                }

                if (condition.includes("snow") || condition.includes("ice") || condition.includes("sleet") || condition.includes("blizzard")) {
                  icon = '<i class="far fa-snowflake"></i>'
                }

                if (condition.includes('thunder')) {
                  icon = '<i class="fas fa-bolt"></i>'
                }

              }

              else if (condition.includes("snow") || condition.includes("ice") || condition.includes("sleet") || condition.includes("blizzard")) {
                icon = '<i class="far fa-snowflake"></i>'

                if (condition.includes('thunder')) {
                  icon = '<i class="fas fa-bolt"></i>'
                }
              }

              else if (condition.includes("thundery")) {
                icon = '<i class="fas fa-bolt"></i>';
              }
              icon += "<h1 class='temp'>"+ Math.round(weather_data[x]["temp_f"]) +"</h1>"
              icon = "<h3>" + hour + "</h3>" + icon;
              icons.push(icon);
            }

            // add icons to divs (based on weather)
            weather_one.innerHTML = icons[0]
            weather_two.innerHTML = icons[1]
            weather_three.innerHTML = icons[2] 

          } else {
            console.log(`error ${request.status} ${request.statusText}`);
          }
        };

      stocks = ["VOO", "DIA", "QQQ"];
      for (var x = 0; x < stocks.length; ++x) {
        let request_stock = new XMLHttpRequest();
        let stock_data = {}
        let stock = stocks[x]
        var url = "https://finnhub.io/api/v1/quote?symbol="+ stocks[x] +"&token=c17boqv48v6se55vrcdg"
        request_stock.open("GET", url);
        request_stock.send();
        request_stock.onload = () => {
          
          if (request_stock.status === 200) {
            stock_data = JSON.parse(request_stock.response);

            var price = stock_data["c"].toFixed(2);
            var last_close = stock_data["pc"]
            var change = (price - last_close) / last_close * 100.0
            var stock_info = "<p class='stock_name'>" + stock + "</p><span class='price'>" + stock_data["c"].toFixed(2);
            
            if (change < 0) {
              change *= -1;
              stock_info += '<i class="down fas fa-long-arrow-alt-down"></i>';
              stock_info += "<span class='down'>" + change.toFixed(2) + "%</span>";         
            }
            else {
              stock_info += '<i class="up fas fa-long-arrow-alt-up"></i>'
              stock_info += "<span class='up'>" + change.toFixed(2) + "%</span>";         
            }

            stock_info += "</span>";

            document.getElementById(stock).innerHTML = stock_info;

            
          } else {
            console.log(`error ${request_stock.status} ${request_stock.statusText}`);
          }
        };
      }

      setTimeout(weatherStocks, 3500);
    }

    weatherStocks();
    
  </script>

</html>
